<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.fd17476c3">
<link rel="alternate" type="application/rss+xml" href="/personal-website/blog/rss.xml" title="Kristijan Bakaric Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-website/blog/atom.xml" title="Kristijan Bakaric Blog Atom Feed"><title data-react-helmet="true">Data Engineering Project - Azure Event Hubs, Function and Cosmos DB - Part 4 | Kristijan Bakaric</title><meta data-react-helmet="true" property="og:title" content="Data Engineering Project - Azure Event Hubs, Function and Cosmos DB - Part 4 | Kristijan Bakaric"><meta data-react-helmet="true" name="description" content="Valid tweet data is flowing into Azure Event Hubs and then being picked up by Azure Function and writing each message to Cosmos DB. In the final testing step, I query the data from Cosmos DB with Power BI and visualize tweets with a set of simple charts."><meta data-react-helmet="true" property="og:description" content="Valid tweet data is flowing into Azure Event Hubs and then being picked up by Azure Function and writing each message to Cosmos DB. In the final testing step, I query the data from Cosmos DB with Power BI and visualize tweets with a set of simple charts."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://baky0905.github.io/personal-website/blog/2021/03/08/data-engineering-part4"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/personal-website/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://baky0905.github.io/personal-website/blog/2021/03/08/data-engineering-part4"><link data-react-helmet="true" rel="alternate" href="https://baky0905.github.io/personal-website/blog/2021/03/08/data-engineering-part4" hreflang="x-default"><link rel="stylesheet" href="/personal-website/assets/css/styles.d23e3c1a.css">
<link rel="preload" href="/personal-website/assets/js/styles.f0712210.js" as="script">
<link rel="preload" href="/personal-website/assets/js/runtime~main.fab28988.js" as="script">
<link rel="preload" href="/personal-website/assets/js/main.79c46ea4.js" as="script">
<link rel="preload" href="/personal-website/assets/js/1.7cb82093.js" as="script">
<link rel="preload" href="/personal-website/assets/js/2.fca674a5.js" as="script">
<link rel="preload" href="/personal-website/assets/js/3.bad86c3d.js" as="script">
<link rel="preload" href="/personal-website/assets/js/ccc49370.180471ef.js" as="script">
<link rel="preload" href="/personal-website/assets/js/7c459c90.378e2022.js" as="script">
<link rel="preload" href="/personal-website/assets/js/5d32438e.0531dc98.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_1oUP">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/personal-website/"><img src="/personal-website/img/logo.png" alt="Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/personal-website/img/logo.png" alt="Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KB</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/personal-website/blog">Blog</a><a class="navbar__item navbar__link" href="/personal-website/blog/tags/projects">Projects</a><a class="navbar__item navbar__link" href="/personal-website/docs/bookmarks">THE Bookmarks</a><a class="navbar__item navbar__link" href="/personal-website/docs/bookmarks-norway">Awesome Norway</a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/kristijanb/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn</a><a href="https://github.com/baky0905" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a class="navbar__item navbar__link" href="/personal-website/docs/about/about-me">About Me</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/personal-website/"><img src="/personal-website/img/logo.png" alt="Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/personal-website/img/logo.png" alt="Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KB</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/personal-website/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/personal-website/blog/tags/projects">Projects</a></li><li class="menu__list-item"><a class="menu__link" href="/personal-website/docs/bookmarks">THE Bookmarks</a></li><li class="menu__list-item"><a class="menu__link" href="/personal-website/docs/bookmarks-norway">Awesome Norway</a></li><li class="menu__list-item"><a href="https://www.linkedin.com/in/kristijanb/" target="_blank" rel="noopener noreferrer" class="menu__link">LinkedIn</a></li><li class="menu__list-item"><a href="https://github.com/baky0905" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/personal-website/docs/about/about-me">About Me</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/personal-website/blog/2021/04/02/docusaurus">From Markdown to a Docusaurus Website via GitHub, gh Actions, and gh pages</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/personal-website/blog/2021/03/08/data-engineering-part4">Data Engineering Project - Azure Event Hubs, Function and Cosmos DB - Part 4</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/personal-website/blog/2021/03/07/data-engineering-part3">Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/personal-website/blog/2021/03/06/data-engineering-part2">Data Engineering Project - Pre-process data - Part 2</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/personal-website/blog/2021/02/28/data-engineering-part1">Data Engineering Project - Intro - Part 1</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Data Engineering Project - Azure Event Hubs, Function and Cosmos DB - Part 4</h1><div class="margin-vert--md"><time datetime="2021-03-08T00:00:00.000Z" class="blogPostDate_fNvV">March 8, 2021  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://www.linkedin.com/in/kristijanb/" target="_blank" rel="noreferrer noopener"><img src="https://media-exp1.licdn.com/dms/image/C4E03AQF-5oI5fHJPjw/profile-displayphoto-shrink_800_800/0/1606336983715?e=1620259200&amp;v=beta&amp;t=VvBP6s8IMDUwKDfvj6B3c-gGmN3IfioALIAboXg_DGE" alt="Kristijan Bakaric"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://www.linkedin.com/in/kristijanb/" target="_blank" rel="noreferrer noopener">Kristijan Bakaric</a></h4><small class="avatar__subtitle">Mr.</small></div></div></header><div class="markdown"><p><img src="https://images.unsplash.com/photo-1575612711678-7e781546adf8?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=2100&amp;q=80"></p><blockquote><p>Valid tweet data is flowing into Azure Event Hubs and then being picked up by Azure Function and writing each message to Cosmos DB. In the final testing step, I query the data from Cosmos DB with Power BI and visualize tweets with a set of simple charts.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>In this post, I will cover the section of the pipeline that goes from event Ingestor - Azure Event Hubs to writing messages in a No-SQL CosmosDB, and finally querying the database via Power BI Desktop  connector with a few simple charts.</p><p><img src="/personal-website/assets/images/diagram-d1cb77fe03b6d9d7184b32c6f196dcb2.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-1---azure-event-hubs"></a>Step 1 - Azure Event Hubs<a class="hash-link" href="#step-1---azure-event-hubs" title="Direct link to heading">#</a></h2><p>Let us first define what is Azure Event Hub and why do we even need it?</p><p><a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-about" target="_blank" rel="noopener noreferrer">Event Hubs</a> represents the &quot;front door&quot; for an event pipeline, often called an event ingestor in solution architectures. An event ingestor is a component or service that sits between event publishers and event consumers to decouple the production of an event stream from the consumption of those events. Event Hubs provides a unified streaming platform with time retention buffer, decoupling event producers from event consumers.</p><p>For more information, please check the [Microsoft Docs](<a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-about" target="_blank" rel="noopener noreferrer">Event Hubs</a>).</p><p>In the Event Hub I created, I chose two partitions with message retention of 1 day. As you can see from the service, you also have a lot of extra functionality to choose from which I decided to ignore for the time being, like using Capture events to save your events to persistent storage (that section in my pipeline is taken care of by Azure Function which writes the messages to blob storage). Then there are also options to do checkpoints and processing of data.</p><p><img src="/personal-website/assets/images/event_hub-916cca2f12c82f13c6be1433f550c151.png"></p><p>To define important concepts of:</p><ul><li>Partition count: Partitions are a data organization mechanism that relates to the downstream parallelism required in consuming applications. The number of partitions in an event hub directly relates to the number of concurrent readers you expect to have. Learn more about partitions.</li><li>Message retention: Message Retention customization is not available in a Basic Tier Namespace. Please upgrade your Namespace to access this feature. </li></ul><p>Event Hubs s a fully managed Platform-as-a-Service (PaaS) with little configuration or management overhead, so you focus on your business solutions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-2---cosmos-db"></a>Step 2 - Cosmos DB<a class="hash-link" href="#step-2---cosmos-db" title="Direct link to heading">#</a></h2><p><a href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction" target="_blank" rel="noopener noreferrer">Cosmos DB</a> is a fully managed NoSQL database for modern app development.</p><p>Cosmos DB has several API options to choose from like key-value, wide-column, graph and document database. Since the documentation recommended that new projects that are being created from scratch should you the Core (SQL), that was obviously my choice.</p><p>The capacity mode when creating the Azure Cosmos DB account was set as Serverless (which is still in public preview).</p><p>Simple configuration is as follows:</p><ul><li>1 database <code>hurricane</code></li><li>1 container <code>tweets</code> partitioned by <code>account_id</code> key</li></ul><p>Azure Cosmos DB has a nice data explorer tab that is available in the Azure portal when you create an Azure Cosmos DB account but also check out a standalone web-based interface that allows you to view and manage the data stored in Cosmos DB under a name <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/data-explorer" target="_blank" rel="noopener noreferrer">Azure Cosmos DB Explorer</a>.</p><p>After sending 10000s of HTTP requests to the API endpoint, it is evident (see figure  below) after querying the tweets container via data explorer, that messages are successfully written to the database.</p><p><img src="/personal-website/assets/images/cosmosdb-data-explorer-67c11192633d0de80611b1321578c70e.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-3---azure-function-triggered-by-azure-event-hub-and-write-to-azure-cosmos-db"></a>Step 3 - Azure Function: Triggered by Azure Event Hub and Write to Azure Cosmos DB<a class="hash-link" href="#step-3---azure-function-triggered-by-azure-event-hub-and-write-to-azure-cosmos-db" title="Direct link to heading">#</a></h2><p>In the previous step I have already tested the function I am going to describe in this section because it was a dependency needed to write the events to the database.</p><p>By its nature, it is a very simple Azure function that has a trigger to respond to an event sent to an event hub event stream, when the function is triggered, the message passed to the functions is typed as a string, and written to a binding defined as Cosmos DB, hurricane database and tweets container/collection.</p><p><img src="/personal-website/assets/images/events-to-cosmos-func-8b122050ad988f24a375c38015343d5e.png"></p><p>Configuration as defined in <code>function.json</code>:</p><div class="mdxCodeBlock_3lFL"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;scriptFile&quot;: &quot;__init__.py&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;bindings&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;type&quot;: &quot;eventHubTrigger&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;name&quot;: &quot;events&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;direction&quot;: &quot;in&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;eventHubName&quot;: &quot;hurricaneevenhub&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;connection&quot;: &quot;hurricanetweet_managehurricanetweets_EVENTHUB&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;cardinality&quot;: &quot;many&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;consumerGroup&quot;: &quot;$Default&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;dataType&quot;: &quot;binary&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;type&quot;: &quot;cosmosDB&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;direction&quot;: &quot;out&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;name&quot;: &quot;outputDocument&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;databaseName&quot;: &quot;hurricane&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;collectionName&quot;: &quot;tweets&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;createIfNotExists&quot;: &quot;true&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;connectionStringSetting&quot;: &quot;hurricanecosmos_DOCUMENTDB&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;partitionKey&quot;: &quot;account_id&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="step-4---plug-the-data-into-power-bi-desktop"></a>Step 4 - Plug the data into Power BI Desktop<a class="hash-link" href="#step-4---plug-the-data-into-power-bi-desktop" title="Direct link to heading">#</a></h2><p>You can easily visualize Cosmos DB data in Power BI by using the <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/powerbi-visualize" target="_blank" rel="noopener noreferrer">connector available in Power BI</a>. </p><p>After connecting to the data and creating a few charts we can see the result on a screenshot. The figure shows the number of tweets, their locations on the map, together with the most common damage flags, and a table with the actual tweet messages.</p><p><img src="/personal-website/assets/images/pbi-visual-e65d90f2608172a7b76d03ce378d9c8c.png"></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/personal-website/blog/tags/dataengineering">dataengineering</a><a class="margin-horiz--sm" href="/personal-website/blog/tags/projects">projects</a><a class="margin-horiz--sm" href="/personal-website/blog/tags/azure">azure</a><a class="margin-horiz--sm" href="/personal-website/blog/tags/python">python</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/personal-website/blog/2021/04/02/docusaurus"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« From Markdown to a Docusaurus Website via GitHub, gh Actions, and gh pages</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/personal-website/blog/2021/03/07/data-engineering-part3"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Data Engineering Project - Azure APIM, Azure Functions, Blob Storage - Part 3 »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#step-1---azure-event-hubs" class="table-of-contents__link">Step 1 - Azure Event Hubs</a></li><li><a href="#step-2---cosmos-db" class="table-of-contents__link">Step 2 - Cosmos DB</a></li><li><a href="#step-3---azure-function-triggered-by-azure-event-hub-and-write-to-azure-cosmos-db" class="table-of-contents__link">Step 3 - Azure Function: Triggered by Azure Event Hub and Write to Azure Cosmos DB</a></li><li><a href="#step-4---plug-the-data-into-power-bi-desktop" class="table-of-contents__link">Step 4 - Plug the data into Power BI Desktop</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Kristijan Bakaric, Built with Docusaurus.</div></div></div></footer></div>
<script src="/personal-website/assets/js/styles.f0712210.js"></script>
<script src="/personal-website/assets/js/runtime~main.fab28988.js"></script>
<script src="/personal-website/assets/js/main.79c46ea4.js"></script>
<script src="/personal-website/assets/js/1.7cb82093.js"></script>
<script src="/personal-website/assets/js/2.fca674a5.js"></script>
<script src="/personal-website/assets/js/3.bad86c3d.js"></script>
<script src="/personal-website/assets/js/ccc49370.180471ef.js"></script>
<script src="/personal-website/assets/js/7c459c90.378e2022.js"></script>
<script src="/personal-website/assets/js/5d32438e.0531dc98.js"></script>
</body>
</html>